<script src="{{ 'sunzi-photo-config.js' | asset_url }}"></script>
{% comment %}
** @name sunzi-multi-photo **
** @version 1.0.0**
{% endcomment %}

{% comment %} 样式库 {% endcomment %}
<style>
  @-webkit-keyframes sk-bouncedelay {
    0%, 80%, 100% { -webkit-transform: scale(0) }
    40% { -webkit-transform: scale(1.0) }
  }

  @keyframes sk-bouncedelay {
    0%, 80%, 100% {
      -webkit-transform: scale(0);
      transform: scale(0);
    } 40% {
      -webkit-transform: scale(1.0);
      transform: scale(1.0);
    }
  }
  html.ov-lock, html.ov-lock body {
  	width: 100%;
    height: 100%;
    overflow: hidden;
  }
  .button {
    width: 100%;
    height: 62px;
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    justify-content: center;
    text-transform: uppercase;
    line-height: 1;
    position: relative;
  }
  #sunzi-button {
    background-color: #bfa175;
    border: none;
    color: #fff !important;
    font-weight: 400;
    font-size: 1.2rem;
    word-spacing: 0.15em;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .mm-continue-custom-button {
    display: none;
    color: #717171;
    border: 1px solid #A1A1A1;
    margin-bottom: 20px !important;
    background: none;
  }
  #sunzi-button #sunzi-button-input {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }
  .dots__loading {
    font-size: 0;
  }
  .dots__loading .dots {
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    align-items: center;
  }
  .sunzi-modal img {
     max-width: none;
  }
  .dots__loading .dots i {
    width: 12px;
    height: 12px;
    margin: 0 2px;
    background-color: #fff;
    border-radius: 100%;
    display: inline-block;
    -webkit-animation: sk-bouncedelay 1.4s infinite ease-in-out both;
    animation: sk-bouncedelay 1.4s infinite ease-in-out both;
  }
  .dots__loading .dots i:first-child {
    -webkit-animation-delay: -0.32s;
    animation-delay: -0.32s;
  }
  .dots__loading .dots i:nth-child(2) {
    -webkit-animation-delay: -0.16s;
    animation-delay: -0.16s;
  }
  .dots__loading i {
    font-weight: normal;
  }
  .sunzi-product-wrap {
    width: 100%;
    margin-bottom: 15px;
  }
  .sunzi-result {
    min-height: 80px;
    display: none;
    position: relative;
    border-radius: 6px;
    border: 1px solid rgb(0, 0, 0, 0.2);
    background: #f2f2f2;
    overflow: hidden;
  }
  .sunzi-result .sunzi-result-loading {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    justify-content: center;
  }
  .sunzi-modal-mask {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 9999999999;
    height: 100%;
    background-color: rgba(0,0,0,0.65);
    display: none;
  }
  .sunzi-modal-wrap {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100%;
    z-index: 9999999999;
    overflow: auto;
    outline: 0;
    display: none;
  }
  .sunzi-modal-wrap .sunzi-modal {
    width: 100%;
    max-width: 500px;
    height: 600px;
    background: #fff;
    position: relative;
    top: 50%;
    left: 50%;
    transform: translateY(-50%);
    margin-left: -240px;
    opacity: 0;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    overflow: hidden;
  }
  .sunzi-modal-wrap .sunzi-modal .canvas-container {
    margin: 0 !important;
    transform: none !important;
    border: 1px solid rgba(0, 0, 0, .15);
  }
  .sunzi-modal-wrap .sunzi-modal.animate {
    opacity: 1;
    transition: all 0.2s ease;
  }
  .sunzi-tips {
    color: #5f5f5f;
    font-size: 13px;
    margin-bottom: 8px;
  }
  #sunzi-input-crop,#sunzi-input-images {
    display: none;
  }
  .select-wrapper {
    display: none;
    background: transparent;
    border: 1px solid rgb(0, 0, 0, 0.2);
  }
  .select-wrapper.select-wrapper-disabled {
    border-color: #d9d9d9;
    color: rgba(0,0,0,0.25);
    background-color: #f5f5f5;
    cursor: not-allowed;
  }
  .select-wrapper.select-wrapper-error {
    border-color: #ed484e;
    color: #ed484e;
  }
  .add-to-cart {
    margin-top: 0 !important;
  }
  .product-quantity {
    margin-top: -12px !important;
  }
  #sunzi-multi-photo {
    height: 100%;
  }
  .sunzi-modal-wrap, .sunzi-modal-mask {
        z-index: 9999999999;
  }
  @media (max-width: 768px) {
    .sunzi-modal-wrap .sunzi-modal {
      top: 0;
      left: 0;
      transform: translateX(0);
      max-width: 100%;
      height: 100%;
      border-radius: 0;
      margin-left: 0;
    }
    #sunzi-button {
      border-radius: 0;
      position: relative;
    }
    .sunzi-modal-mask {
      position: fixed;
      z-index: 9;
    }
    .sunzi-modal-wrap {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      overflow: auto;
      outline: 0;
      display: none;
    }
    .sunzi-modal-wrap .sunzi-modal .canvas-container {
      border: none;
    }
  }
  .product-form__item--submit{
  	display: none!important;
  }
</style>

{% comment %} 调用按钮 {% endcomment %}
<div class="sunzi-product-wrap">
  {% comment %} 定制按钮 {% endcomment %}
  <input type="text" id="sunzi-input-crop" name="properties[multi_crop]" required="required" >
  <input type="text" id="sunzi-input-images" name="properties[multi_images]" required="required" >
  {% if product.tags contains 'photo-15' %}
    <div class="sunzi-tips">You can upload 5 to 15 photos at one time.</div>
  {% else %}
    <div class="sunzi-tips">You can upload 5 to 10 photos at one time.</div>
  {% endif %}
  <button type="button" data-type="sketch" id="sunzi-button" class="button mm-input-button-submit mm-border-radius-4 dots__loading event-custom-now">
    <span class="dots">
      <i></i>
      <i></i>
      <i></i>
    </span>
    <input id="sunzi-button-input" disabled type="file" multiple  accept="image/*" />
  </button>
</div>

{% comment %} 模态框 {% endcomment %}
<div class="sunzi-modal-mask"></div>
<div id="sunzi-modal" class="sunzi-modal-wrap">
  <div class="sunzi-modal">
    <div id="sunzi-multi-photo"></div>
  </div>
</div>

{% comment %} javascript {% endcomment %}
<script src="https://spic.qn.cdn.imaiyuan.com/sunzi/js/react.production.min.js" crossorigin></script>
<script src="https://spic.qn.cdn.imaiyuan.com/sunzi/js/react-dom.production.min.js" crossorigin></script>
<script src="https://spic.qn.cdn.imaiyuan.com/sunzi/js/three.min.js" crossorigin></script>
<script src="https://sunzi7n.imaiyuan.com/core/sunzi.multi.photo.test.5c00f.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-174677632-1"></script> 


<script defer>
  $(document).ready(function() {
    
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-174677632-1');
    
    const land = window.location.href.split('?share=')[1];
    if (land) {
      if (land.indexOf('fbclid') > -1) {
        console.log('fb')
        gtag('event', 'share_land_facebook');
      } else
      	gtag('event', 'share_land_' + land);
    }
    
    

    var sku = '{{ product.selected_or_first_available_variant.sku }}';
                                  
    if(typeof sunziPhotoConfig == 'undefined'){
      console.log('No configuration information!');
    }
    var jsonCustom = sunziPhotoConfig[sku];
    
    console.log("jsonCustom", jsonCustom);
      
    $('#sunzi-button').removeClass("dots__loading");
    $('#sunzi-button-input').removeAttr("disabled");
    $('#sunzi-button').find('span').html('UPLOAD PHOTOS');

    $('#sunzi-button-input').change( async function() {
        var files = $("#sunzi-button-input").get(0).files;
        var promiseArray = Array.from(files).map((item) => fileToBase64(item))
        var base64Array = await Promise.all(promiseArray);
        $('#sunzi-button-input').attr("type", "text");
        $('#sunzi-modal').show(200, function() {
            lock();
            $('.sunzi-modal-mask').show();
            $('.sunzi-modal').addClass('animate');
            // 渲染组件
            ReactDOM.render(
                React.createElement(MultiPhoto.PhotoFilmShare, {
                    shop: { language: 'en' },
                    handleType:'cropper',
                  	sources: base64Array,
                    imageList: jsonCustom.photo,
                    minCount: jsonCustom.minCount,
                    gtag: gtag,
                    supportSort: true,
                  	needCompose: true,
                    onClose: modalClose,
                    onConfirm: function(result, compose, share) {
                        unlock();
                        console.log(share)
                        var images = {};
                        result.forEach((item, index) => {
                          images[index] = { src: item.handle };
                        });
                        $('.sunzi-modal-wrap').hide();
                        $('.sunzi-modal-mask').hide();
                        $('#sunzi-button-input').attr("type", "file");
                      
                        if (share) { // 分享状态下
                          // 把分享产品加车 产品ID问amber
                          // 把 VIP服务加车
                          var param = {
                              "id": '35641903906968', 
                              "properties[multi_images]": JSON.stringify(images), 
                              "properties[multi_crop]": compose
                          };
                          Cart.add(param).then((item) => {
                            var tempvip = cateTempVip();
                            Cart.add({id: '35643825062040', "properties[_tempVip]":tempvip}).then(function(){
                              Dialog.open('#shopify-section-cart-success')
                            })
                          })
                        } else {
                          $('#sunzi-input-images').val(JSON.stringify(images));
                          $('#sunzi-input-crop').val(compose);
                          $('.product-form__cart-submit').click();
                        }
                    }
                }, null ), document.getElementById('sunzi-multi-photo')
            );
        });
    });
    
    // 锁屏
    function lock () {
      SCROLLTOP = $('html').scrollTop();
      $('html').addClass('ov-lock');
    }

    // 解锁
    function unlock () {
      $('html').removeClass('ov-lock');
      $('html, body').scrollTop(SCROLLTOP);
    }

    function modalClose(confirm) {
      unlock();
      $('#sunzi-modal').hide();
      $('.sunzi-modal-mask').hide();
      $('.sunzi-modal').removeClass('animate');
      $('#sunzi-button-input').attr("type", "file");
    }
  });


  function fileToBase64 (img) {
    return new Promise(function (resolve, reject) {
      const reader = new FileReader()
      reader.addEventListener('load', () => resolve(reader.result))
      reader.readAsDataURL(img)
    })
  }

</script>
